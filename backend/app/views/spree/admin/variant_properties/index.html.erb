<%= render 'spree/admin/shared/product_sub_menu' %>
<%= render 'spree/admin/shared/product_tabs', :current => 'Product Properties' %>
<%= render 'spree/shared/error_messages', :target => @product %>

<% content_for :page_actions do %>
  <% if can?(:create, Spree::VariantProperty) %>
    <ul class="tollbar inline-menu">
      <li>
        <%= link_to_add_fields Spree.t(:add_product_properties), 'tbody#product_properties', :class => 'plus button' %>
      </li>
      <li>
        <span id="new_ptype_link">
          <%= link_to Spree.t(:select_from_prototype), available_admin_prototypes_url, :remote => true, 'data-update' => 'prototypes', :class => 'button fa fa-copy' %>
        </span>
      </li>
    </ul>
  <% end %>
<% end %>

<%= form_for @product, url: update_product_admin_product_variant_properties_url(@product), method: :put do |f| %>
  <fieldset>
    <legend align="center"><%= Spree.t(:product_properties) %></legend>
    <div data-hook="add_variant_properties"></div>

    <%= f.fields_for :master, @product.master do |master_variant_form| %>

      <div id="prototypes" data-hook></div>
      <%= image_tag 'select2-spinner.gif', plugin: 'spree', style: 'display:none;', id: 'busy_indicator' %>

      <table class="index sortable" data-hook data-sortable-link="<%= update_positions_admin_product_variant_properties_url %>">
        <thead>
          <tr data-hook="variant_properties_header">
            <th colspan="2"><%= Spree.t(:property) %></th>
            <th><%= Spree.t(:value) %></th>
            <th class="actions"></th>
          </tr>
        </thead>
        <tbody id="product_properties" data-hook>
          <%= master_variant_form.fields_for :variant_properties do |pp_form| %>
            <%= render 'variant_property_fields', f: pp_form %>
          <% end %>
        </tbody>
      </table>

      <% if can?([:create, :update], Spree::VariantProperty) %>
        <%= render 'spree/admin/shared/edit_resource_links' %>
      <% end %>
      <%= hidden_field_tag 'clear_variant_properties', 'true' %>

    <% end %>
  </fieldset>
<% end %>

<%= form_tag admin_product_variant_properties_path, method: :get, id: 'variant_option_value_selections' do %>
  <fieldset class='no-border-bottom'>
    <legend align="center"><%= Spree.t(:variant_properties) %></legend>
    <fieldset class='no-border-top'>
      <% @option_types.each do |option_type, option_values| %>
        <div class="field">
          <%= label :option_type_presentation, option_type.presentation %>
          <%= select_tag "ovi[]", options_from_collection_for_select(option_values, :id, :presentation, params[:ovi]), class: 'select2 fullwidth', include_blank: true, id: "#{option_type.name}_option_type_select" %>
        </div>
      <% end %>
      <div class="form-buttons filter-actions actions">
        <%= button Spree.t(:filter_results) %>
        <% if @option_value_ids.present? %>
          <span class="or"><%= Spree.t(:or) %></span>
          <%= link_to_add_fields Spree.t(:add_variant_properties), 'tbody#variant_properties', class: 'plus button' %>
        <% end %>
      </div>
    </fieldset>
  </fieldset>
<% end %>

<%= form_for Spree::Variant.new, url: update_variants_admin_product_variant_properties_url(@product), method: :put do |f| %>
  <%= hidden_field_tag 'filtered_variant_ids', @variant_ids %>
  <%= hidden_field_tag 'option_value_ids', @option_value_ids %>
  <% if @option_value_ids.present? %>
    <fieldset class='no-border-top'>
      <table class="index sortable" data-hook data-sortable-link="<%= update_positions_admin_product_variant_properties_url %>">
        <thead>
          <tr data-hook="variant_properties_header">
            <th colspan="2"><%= Spree.t(:property) %></th>
            <th><%= Spree.t(:value) %></th>
            <th class="actions"></th>
          </tr>
        </thead>
        <tbody id="variant_properties" data-hook>
          <%= f.fields_for :variant_properties, @variant_properties do |vp_field| %>
            <%= render 'variant_property_fields', f: vp_field %>
          <% end %>
        </tbody>
      </table>

      <% if can?([:create, :update], Spree::VariantProperty) %>
        <%= render 'spree/admin/shared/edit_resource_links' %>
      <% end %>
    </fieldset>
  <% end %>
<% end %>

<%= javascript_tag do -%>
  var properties = <%= raw(@properties.to_json) %>;
  $('#product_properties, #variant_properties').on('keydown', 'input.autocomplete', function() {
    already_auto_completed = $(this).is('ac_input');
    if (!already_auto_completed) {
      $(this).autocomplete({source: properties});
      $(this).focus();
    }
  });
<% end -%>
